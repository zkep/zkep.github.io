<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="Love Your Life">
    <meta property="og:type" content="website">
    <meta name="description" content="Love Your Life">
    <meta name="keyword"  content="zkep,go">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        工厂模式 - zkep日常
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 6.0.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> zkep‘s blog </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="https://avatars.githubusercontent.com/u/36965534" />    
        </div>
        <div class="name">
            <i>zkep</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82"><span class="toc-text">简单工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-text">单元测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95"><span class="toc-text">工厂方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95-1"><span class="toc-text">单元测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82"><span class="toc-text">抽象工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95-2"><span class="toc-text">单元测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DI-%E5%AE%B9%E5%99%A8"><span class="toc-text">DI 容器</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> zkep‘s blog </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        工厂模式
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2021-03-27 18:51:02</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#go" title="go">go</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h3 id="简单工厂"><a href="#简单工厂" class="headerlink" title="简单工厂"></a>简单工厂</h3><p>由于 Go 本身是没有构造函数的，一般而言我们采用 NewName 的方式创建对象&#x2F;接口，当它返回的是接口的时候，其实就是简单工厂模式</p>
<span id="more"></span>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 简单工厂</span></span><br><span class="line"><span class="keyword">type</span> IRuleConfigParser <span class="keyword">interface</span> &#123;</span><br><span class="line">     Pasre(data []<span class="type">byte</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jsonRuleConfigParser</span></span><br><span class="line"><span class="keyword">type</span> jsonRuleConfigParser <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(J jsonRuleConfigParser)</span></span> Pasre(data []<span class="type">byte</span>) &#123;</span><br><span class="line">     <span class="built_in">panic</span>(<span class="string">&quot;implement me&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// yamlRuleConfigParser</span></span><br><span class="line"><span class="keyword">type</span> yamlRuleConfigParser <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(Y yamlRuleConfigParser)</span></span> Pasre(data []<span class="type">byte</span>) &#123;</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;implement me&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIRuleConfigParser</span><span class="params">(t <span class="type">string</span>)</span></span> IRuleConfigParser&#123;</span><br><span class="line">    <span class="keyword">switch</span> t &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;json&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonRuleConfigParser&#123;&#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;yaml&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> yamlRuleConfigParser&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> design</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNewIRuleConfigParser</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"> <span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">     t <span class="type">string</span></span><br><span class="line"> &#125;</span><br><span class="line"> tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">        name <span class="type">string</span></span><br><span class="line">        args args</span><br><span class="line">        want IRuleConfigParser</span><br><span class="line">     &#125;&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">            args: args&#123;t: <span class="string">&quot;json&quot;</span>&#125;,</span><br><span class="line">            want: jsonRuleConfigParser&#123;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;yaml&quot;</span>,</span><br><span class="line">            args: args&#123;t: <span class="string">&quot;yaml&quot;</span>&#125;,</span><br><span class="line">            want: yamlRuleConfigParser&#123;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">        t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> got := NewIRuleConfigParser(tt.args.t); !reflect.DeepEqual(got, tt.want) &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;NewIRuleConfigParser() = %v, want %v&quot;</span>, got, tt.want)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 工厂方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IRuleConfigParserFactory <span class="keyword">interface</span>&#123;</span><br><span class="line">    CreateParser() IRuleConfigParser</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> jsonRuleConfigParserFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(J jsonRuleConfigParserFactory)</span></span> CreateParser() IRuleConfigParser&#123;</span><br><span class="line">    <span class="keyword">return</span> jsonRuleConfigParser&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> yamlRuleConfigParserFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(Y yamlRuleConfigParserFactory)</span></span> CreateParser() IRuleConfigParser&#123;</span><br><span class="line">    <span class="keyword">return</span> yamlRuleConfigParser&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewIRuleConfigParserFactory</span><span class="params">(t <span class="type">string</span>)</span></span> IRuleConfigParserFactory&#123;</span><br><span class="line">    <span class="keyword">switch</span> t &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;json&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonRuleConfigParserFactory&#123;&#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;yaml&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> yamlRuleConfigParserFactory&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="单元测试-1"><a href="#单元测试-1" class="headerlink" title="单元测试"></a>单元测试</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNewIRuleConfigParserFactory</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="keyword">type</span> args <span class="keyword">struct</span> &#123;</span><br><span class="line">        t <span class="type">string</span></span><br><span class="line">    &#125;</span><br><span class="line"> tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">        name <span class="type">string</span></span><br><span class="line">        args args</span><br><span class="line">        want IRuleConfigParserFactory</span><br><span class="line">     &#125;&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">            args: args&#123;t: <span class="string">&quot;json&quot;</span>&#125;,</span><br><span class="line">            want: jsonRuleConfigParserFactory&#123;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;yaml&quot;</span>,</span><br><span class="line">            args: args&#123;t: <span class="string">&quot;yaml&quot;</span>&#125;,</span><br><span class="line">            want: yamlRuleConfigParserFactory&#123;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">        t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> got := NewIRuleConfigParserFactory(tt.args.t); !reflect.DeepEqual(got, tt.want) &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;NewIRuleConfigParserFactory() = %v, want %v&quot;</span>, got, tt.want)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="抽象工厂"><a href="#抽象工厂" class="headerlink" title="抽象工厂"></a>抽象工厂</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> IRuleConfigParser <span class="keyword">interface</span> &#123;</span><br><span class="line">     Pasre(data []<span class="type">byte</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jsonRuleConfigParser</span></span><br><span class="line"><span class="keyword">type</span> jsonRuleConfigParser <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(J jsonRuleConfigParser)</span></span> Pasre(data []<span class="type">byte</span>) &#123;</span><br><span class="line">     <span class="built_in">panic</span>(<span class="string">&quot;implement me&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ISystemConfigParser <span class="keyword">interface</span> &#123;</span><br><span class="line">    ParseSystem(data []<span class="type">byte</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> jsonSystemConfigParser <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(j jsonSystemConfigParser)</span></span> ParseSystem(data []<span class="type">byte</span>) &#123;</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">&quot;implement me&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IConfigParserFactory <span class="keyword">interface</span> &#123;</span><br><span class="line">    CreateRuleParser() IRuleConfigParser</span><br><span class="line">    CreateSystemParser() ISystemConfigParser</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> jsonConfigParserFactory <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(J jsonConfigParserFactory)</span></span> CreateRuleParser() IRuleConfigParser &#123;</span><br><span class="line">    <span class="keyword">return</span> jsonRuleConfigParser&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(J jsonConfigParserFactory)</span></span> CreateSystemParser() ISystemConfigParser &#123;</span><br><span class="line">    <span class="keyword">return</span> jsonSystemConfigParser&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="单元测试-2"><a href="#单元测试-2" class="headerlink" title="单元测试"></a>单元测试</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test_jsonConfigParserFactory_CreateRuleParser</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">            name <span class="type">string</span></span><br><span class="line">            want IRuleConfigParser</span><br><span class="line">        &#125;&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">            want: jsonRuleConfigParser&#123;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">        t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">            j := jsonConfigParserFactory&#123;&#125;</span><br><span class="line">            <span class="keyword">if</span> got := j.CreateRuleParser(); !reflect.DeepEqual(got, tt.want) &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;CreateRuleParser() = %v, want %v&quot;</span>, got, tt.want)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test_jsonConfigParserFactory_CreateSystemParser</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">            name <span class="type">string</span></span><br><span class="line">            want ISystemConfigParser</span><br><span class="line">        &#125;&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">            want: jsonSystemConfigParser&#123;&#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">        t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">            j := jsonConfigParserFactory&#123;&#125;</span><br><span class="line">            <span class="keyword">if</span> got := j.CreateSystemParser(); !reflect.DeepEqual(got, tt.want) &#123;</span><br><span class="line">                t.Errorf(<span class="string">&quot;CreateSystemParser() = %v, want %v&quot;</span>, got, tt.want)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="DI-容器"><a href="#DI-容器" class="headerlink" title="DI 容器"></a>DI 容器</h3><p>golang 现有的依赖注入框架:</p>
<ul>
<li>使用反射实现的: <a class="link"   target="_blank" rel="noopener" href="https://github.com/uber-go/dig" >https://github.com/uber-go/dig<i class="fas fa-external-link-alt"></i></a></li>
<li>使用 generate 实现的: <a class="link"   target="_blank" rel="noopener" href="https://github.com/google/wire" >https://github.com/google/wire<i class="fas fa-external-link-alt"></i></a><br>下文将通过反射实现一个类似 dig 简单的 demo，在课程里面的例子是读取配置文件，然后进行生成，下面提供是通过 provider 进行构建依赖关系。</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Container DI 容器</span></span><br><span class="line"><span class="keyword">type</span> Container <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 假设一种类型只能有一个 providor 提供</span></span><br><span class="line">    providers <span class="keyword">map</span>[reflect.Type]provider</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  缓存以生成的对象</span></span><br><span class="line">    results <span class="keyword">map</span>[reflect.Type]reflect.Value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> provider <span class="keyword">struct</span> &#123;</span><br><span class="line">    value  reflect.Value</span><br><span class="line">    params []reflect.Type</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建容器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span></span> *Container &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Container&#123;</span><br><span class="line">        providers: <span class="keyword">map</span>[reflect.Type]provider&#123;&#125;,</span><br><span class="line">        results:    <span class="keyword">map</span>[reflect.Type]reflect.Value&#123;&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isError</span><span class="params">(t reflect.Type)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> t.Kind() != reflect.Interface &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> t.Implements(reflect.TypeOf(reflect.TypeOf((*<span class="type">error</span>)(<span class="literal">nil</span>)).Elem()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Provide 对象提供者，需要传入一个对象的工厂方法，后续会用于对象的创建</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span></span> Provide(constructor <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    v := reflect.ValueOf(constructor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v.Kind() != reflect.Func &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;constructor must be a func&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vt := v.Type()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取参数</span></span><br><span class="line">    params := <span class="built_in">make</span>([]reflect.Type, vt.NumIn())</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vt.NumIn(); i++ &#123;</span><br><span class="line">         params[i] = vt.In(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取返回值</span></span><br><span class="line">    results := <span class="built_in">make</span>([]reflect.Type, vt.NumOut())</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vt.NumOut(); i++ &#123;</span><br><span class="line">        results[i] = vt.Out(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    provider := provider&#123; value: v, params: params&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存不同类型的provider</span></span><br><span class="line">    <span class="keyword">for</span> _, result := <span class="keyword">range</span> results &#123;</span><br><span class="line">        <span class="comment">// 判断返回值error</span></span><br><span class="line">        <span class="keyword">if</span> isError(result) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> _, ok := c.providers[result]; ok &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s had a provider&quot;</span>, result)</span><br><span class="line">        &#125;</span><br><span class="line">        c.providers[result] = provider</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Invoke 函数执行入口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span></span> Invoke(function <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">    v := reflect.ValueOf(function)</span><br><span class="line">    <span class="comment">// 仅支持函数 provider</span></span><br><span class="line">    <span class="keyword">if</span> v.Kind() != reflect.Func &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;constructor must be a func&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vt := v.Type()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">    params:= <span class="built_in">make</span>([]reflect.Value,vt.NumIn())</span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;vt.NumIn();i++&#123;</span><br><span class="line">        params[i], err = c.buildParam(vt.In(i))</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v.Call(params)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// buildParam 构建参数</span></span><br><span class="line"><span class="comment">// 1. 从容器中获取 provider</span></span><br><span class="line"><span class="comment">// 2. 递归获取 provider 的参数值</span></span><br><span class="line"><span class="comment">// 3. 获取到参数之后执行函数</span></span><br><span class="line"><span class="comment">// 4. 将结果缓存并且返回结果</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span></span> buildParam(param reflect.Type)(val reflect.Value, err <span class="type">error</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> result, ok := c.results[param]; ok &#123;</span><br><span class="line">        <span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    provider, ok := c.providers[param]</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> reflect.Value&#123;&#125;, fmt.Errorf(<span class="string">&quot;can not found provider: %s&quot;</span>, param)</span><br><span class="line">    &#125;</span><br><span class="line">    params := <span class="built_in">make</span>([]reflect.Value, <span class="built_in">len</span>(provider.params))</span><br><span class="line">    <span class="keyword">for</span> i, p := <span class="keyword">range</span> provider.params &#123;</span><br><span class="line">        params[i], err = c.buildParam(p)</span><br><span class="line">    &#125;</span><br><span class="line">    results := provider.value.Call(params)</span><br><span class="line">    <span class="keyword">for</span> _, result := <span class="keyword">range</span> results &#123;</span><br><span class="line">        <span class="comment">// 判断是否报错</span></span><br><span class="line">        <span class="keyword">if</span> isError(result.Type()) &amp;&amp; !result.IsNil() &#123;</span><br><span class="line">            <span class="keyword">return</span> reflect.Value&#123;&#125;, fmt.Errorf(<span class="string">&quot;%s call err: %+v&quot;</span>, provider, result)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !isError(result.Type()) &amp;&amp; !result.IsNil() &#123;</span><br><span class="line">            c.results[result.Type()] = result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c.results[param], <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <!-- <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span> -->
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
